#!/usr/bin/env bash
set -euo pipefail
IFS=$'\n\t'

plugin_name="$1"
pkg_name="$2"
plugin_subdir="$3"
release_msg="$1"

aur_dev_repo_root=~/build/

cp "packaging/arch/PKGBUILD_${plugin_name}" "${aur_dev_repo_root}/${pkg_name}/PKGBUILD"
cd "${aur_dev_repo_root}/${pkg_name}/"
updpkgsums ; makepkg -fsr ; makepkg --printsrcinfo > .SRCINFO
git diff
echo
echo "??????????????????????????????????????????????????"
echo "??    Confirm push to ${pkg_name} AUR? [y/N]    ??"
echo "??????????????????????????????????????????????????"
echo -n "> "
read -r answer
echo
if [[ "${answer}" = "y" ]] ; then
	git add PKGBUILD .SRCINFO
	git commit -m "push version (${release_msg})"
	git push origin HEAD
fi

cd -
cp "${aur_dev_repo_root}/${pkg_name}/PKGBUILD" "packaging/arch/PKGBUILD_${plugin_name}"
echo
echo "???????????????????????????????????????????????????????????????????????????????????????"
echo "??    Confirm pushing new version of '${plugin_name}' to Oomox GitHub repo? [y/N]    ??"
echo "???????????????????????????????????????????????????????????????????????????????????????"
echo -n "> "
read -r answer
echo
if [[ "${answer}" = "y" ]] ; then
	git add "plugins/${plugin_name}${plugin_subdir}" "packaging/arch/PKGBUILD_${plugin_name}"
	git commit -m "chore(plugins: ${plugin_name}): update submodule (${release_msg})"
	git push origin HEAD
fi

echo
echo '$$$$$$$$$$$$$$$$$$$$$$$$$'
echo '$$    Full Success!    $$'
echo '$$$$$$$$$$$$$$$$$$$$$$$$$'
exit 0
